---
title: Redis 缓存击穿 穿透  雪崩及解决办法
date: 2019-08-02
comments: false
toc: true
categories: "Redis"
tags: [redis, 缓存击穿, 缓存穿透, 缓存雪崩]
---

###  缓存穿透

#### 什么是缓存穿透

key对应的数据在**数据源并不存**在，每次针对此key的请求从缓存获取不到，请求都会到数据源，从而可能压垮数据源。比如用一个不存在的用户id获取用户信息，不论缓存还是数据库都没有，若黑客利用此漏洞进行攻击可能压垮数据库。

#### 缓存穿透解决方案

一个一定不存在缓存及查询不到的数据，由于缓存是不命中时被动写的，并且出于容错考虑，如果从**存储层查不到数据则不写入缓存**，这将导致这个不存在的数据每次请求都要到存储层去查询，失去了缓存的意义。

##### 方式一: 布隆过滤器

将所有可能存在的数据哈希到一个足够大的bitmap中，一个一定不存在的数据会被 这个bitmap拦截掉，从而避免了对底层存储系统的查询压力。

#### 方式二:

另外也有一个更为简单粗暴的方法（我们采用的就是这种），如果一个查询返回的数据为空（不管是数据不存在，还是系统故障），我们仍然把这个空结果进行缓存，但它的过期时间会很短，最长不超过五分钟。

### 缓存击穿

#### 什么是缓存击穿?

key对应的数据存在，但在redis中过期，此时若有大量并发请求过来，这些请求发现缓存过期一般都会从后端DB加载数据并回设到缓存，这个时候大并发的请求可能会瞬间把后端DB压垮。

#### 解决方案

1. 设置热点数据永远不过期。
2. 加互斥锁

### 缓存雪崩

#### 什么 缓存雪崩

当缓存服务器重启或者大量缓存集中在某一个时间段失效，这样在失效的时候，也会给后端系统(比如DB)带来很大压力

#### 解决方案

与缓存击穿的区别在于这里针对很多key缓存，前者则是某一个key。

缓存正常从Redis中获取，示意图如下：

![](https://gitee.com/qilitang/Img/raw/master/img/2020050621530211.png)

缓存失效瞬间示意图如下：

![](https://gitee.com/qilitang/Img/raw/master/img/20200506215850.png)

缓存失效时的雪崩效应对底层系统的冲击非常可怕！大多数系统设计者考虑用加锁或者队列的方式保证来保证不会有大量的线程对数据库一次性进行读写，从而避免失效时大量的并发请求落到底层存储系统上。还有一个简单方案就时讲缓存失效时间分散开，比如我们可以在原有的失效时间基础上增加一个随机值，比如1-5分钟随机，这样每一个缓存的过期时间的重复率就会降低，就很难引发集体失效的事件。